<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.6.1 -->
<title>Imdrasil Homebrew Stuff | Personal site</title>
<meta name="generator" content="Jekyll v3.9.0" />
<meta property="og:title" content="Imdrasil Homebrew Stuff" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Personal site" />
<meta property="og:description" content="Personal site" />
<link rel="canonical" href="https://imdrasil.github.io/jennifer.cr/docs/validation.html" />
<meta property="og:url" content="https://imdrasil.github.io/jennifer.cr/docs/validation.html" />
<meta property="og:site_name" content="Imdrasil Homebrew Stuff" />
<script type="application/ld+json">
{"url":"https://imdrasil.github.io/jennifer.cr/docs/validation.html","description":"Personal site","@type":"WebPage","headline":"Imdrasil Homebrew Stuff","@context":"https://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://imdrasil.github.io/feed.xml" title="Imdrasil Homebrew Stuff" /></head>
<body><header class="site-header">
  <div class="wrapper">
    <a class="site-title" rel="author" href="/">Imdrasil Homebrew Stuff</a>
  </div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title"></h1>
  </header>

  <div class="post-content">
    <header class="site-header" role="banner">
  <div class="wrapper">
    <nav class="site-nav">
      <div class="trigger">
        
          <a class="page-link" href="./callbacks">Callbacks</a>
        
          <a class="page-link" href="./model_sti">STI</a>
        
          <a class="page-link" href="./timestamps">Timestamps</a>
        
          <a class="page-link" href="./eager_loading">Eager Loading</a>
        
          <a class="page-link" href="./getting_started">Getting started</a>
        
          <a class="page-link" href="./validation">Validation</a>
        
          <a class="page-link" href="./query_dsl">Query DSL</a>
        
          <a class="page-link" href="./configuration">Configuration</a>
        
          <a class="page-link" href="./index">Jennifer Documentation</a>
        
          <a class="page-link" href="./model_mapping">Mapping</a>
        
          <a class="page-link" href="./multiple_adapters">Multiple adapters</a>
        
          <a class="page-link" href="./view">Views</a>
        
          <a class="page-link" href="./transaction_and_lock">Transaction &amp; Lock</a>
        
          <a class="page-link" href="./time">Time</a>
        
          <a class="page-link" href="./serialization">Serialization</a>
        
          <a class="page-link" href="./internationalization">Internationalization</a>
        
          <a class="page-link" href="./record">Record</a>
        
          <a class="page-link" href="./migration">Migration</a>
        
          <a class="page-link" href="./pagination_and_ordering">Pagination &amp; Ordering</a>
        
          <a class="page-link" href="./relations">Relationships</a>
        
          <a class="page-link" href="./crud">CRUD</a>
        
          <a class="page-link" href="./aggregation">Aggregations</a>
        
          <a class="page-link" href="./authentication">Authentication</a>
        
          <a class="page-link" href="./command_line">Command Line</a>
        
          <a class="page-link" href="./model_scopes">Scopes</a>
        
      </div>
    </nav>
  </div>
</header>

<h1 id="validation">Validation</h1>

<p>Here is an example of validation usage:</p>

<div class="language-crystal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">Jennifer</span><span class="o">::</span><span class="no">Model</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">mapping</span><span class="p">({</span>
    <span class="c1"># ...</span>
    <span class="ss">login: </span><span class="no">String</span>
  <span class="p">})</span>

  <span class="n">validates_length</span> <span class="ss">:login</span><span class="p">,</span> <span class="ss">in: </span><span class="mi">8</span><span class="o">..</span><span class="mi">16</span>
<span class="k">end</span>
</code></pre></div></div>

<div class="language-crystal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="no">User</span><span class="p">.</span><span class="nf">create</span><span class="p">({</span><span class="ss">login: </span><span class="s2">"login"</span><span class="p">}).</span><span class="nf">valid?</span> <span class="c1"># =&gt; false</span>
<span class="no">User</span><span class="p">.</span><span class="nf">create</span><span class="p">({</span><span class="ss">login: </span><span class="s2">"loginlogin"</span><span class="p">}).</span><span class="nf">valid?</span> <span class="c1"># =&gt; true</span>
</code></pre></div></div>

<p>As you can see, our validation lets us know that our <code class="language-plaintext highlighter-rouge">User</code> is not valid with a too short login attribute. Once we set long enough value <code class="language-plaintext highlighter-rouge">User</code> will not be persisted to the database.</p>

<h2 id="trigger-validation">Trigger validation</h2>

<p>The following model methods triggers validations in a scope of own execution:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">.create</code></li>
  <li><code class="language-plaintext highlighter-rouge">.create!</code></li>
  <li><code class="language-plaintext highlighter-rouge">#validate</code></li>
  <li><code class="language-plaintext highlighter-rouge">#validate!</code></li>
  <li><code class="language-plaintext highlighter-rouge">#valid?</code></li>
  <li><code class="language-plaintext highlighter-rouge">#save</code></li>
  <li><code class="language-plaintext highlighter-rouge">#save_without_transaction</code></li>
  <li><code class="language-plaintext highlighter-rouge">#save!</code></li>
  <li><code class="language-plaintext highlighter-rouge">#update</code></li>
  <li><code class="language-plaintext highlighter-rouge">#update!</code></li>
</ul>

<blockquote>
  <p>NOTE: Bang method version will raise an exception if record is invalid.</p>

  <p>NOTE: <code class="language-plaintext highlighter-rouge">#valid?</code> is an alias for <code class="language-plaintext highlighter-rouge">#validate!</code>.</p>

  <p><code class="language-plaintext highlighter-rouge">Jennifer::Query#patch</code> also invokes validation (and callbacks) for each matched record.</p>
</blockquote>

<p><code class="language-plaintext highlighter-rouge">#validate!</code> method invokes validation callbacks. Be aware: <code class="language-plaintext highlighter-rouge">after_validation</code> callbacks may not be triggered if record is invalid or <code class="language-plaintext highlighter-rouge">before_validation</code> has raised <code class="language-plaintext highlighter-rouge">Jennifer::Skip</code> exception.</p>

<h2 id="skip-validation">Skip validation</h2>

<p>Some methods skip validation on invocation:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">Model::Base#invalid?</code></li>
  <li><code class="language-plaintext highlighter-rouge">Model::Base#save(skip_validation: true)</code></li>
  <li><code class="language-plaintext highlighter-rouge">Model::Base#update_column</code></li>
  <li><code class="language-plaintext highlighter-rouge">Model::Base#update_columns</code></li>
  <li><code class="language-plaintext highlighter-rouge">QueryBuilder::Query#update</code></li>
  <li><code class="language-plaintext highlighter-rouge">QueryBuilder::Query#increment</code></li>
  <li><code class="language-plaintext highlighter-rouge">QueryBuilder::Query#decrement</code></li>
</ul>

<blockquote>
  <p>NOTE: <code class="language-plaintext highlighter-rouge">#invalid?</code> method will only check if <code class="language-plaintext highlighter-rouge">#errors</code> is empty.</p>
</blockquote>

<h2 id="validation-macros">Validation macros</h2>

<p>Please take into account that all validators described below implement singleton pattern - there is only one instance of each of them in application.</p>

<h3 id="validates_acceptance"><code class="language-plaintext highlighter-rouge">validates_acceptance</code></h3>

<p>This macro validates that a given field equals to true or be one of given values. This is useful for validating checkbox value:</p>

<div class="language-crystal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">Jennifer</span><span class="o">::</span><span class="no">Model</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">mapping</span><span class="p">(</span>
    <span class="c1"># ...</span>
  <span class="p">)</span>

  <span class="kp">property</span> <span class="n">terms_of_service</span> <span class="o">=</span> <span class="kp">false</span>
  <span class="kp">property</span> <span class="n">eula</span> <span class="p">:</span> <span class="no">String</span><span class="p">?</span>

  <span class="n">validates_acceptance</span> <span class="p">:</span><span class="n">terms_of_service</span>
  <span class="n">validates_acceptance</span> <span class="ss">:eula</span><span class="p">,</span> <span class="ss">accept: </span><span class="sx">%w(true accept yes)</span>
<span class="k">end</span>
</code></pre></div></div>

<p>By default <code class="language-plaintext highlighter-rouge">"1"</code> and <code class="language-plaintext highlighter-rouge">true</code> is recognized as accepted values, but, as described, this behavior could be override by passing <code class="language-plaintext highlighter-rouge">accept</code> option with array.</p>

<h3 id="validates_confirmation"><code class="language-plaintext highlighter-rouge">validates_confirmation</code></h3>

<p>This validation helps to check if confirmation field was filled with same value as specified.</p>

<div class="language-crystal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">Jennifer</span><span class="o">::</span><span class="no">Model</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">mapping</span><span class="p">(</span>
    <span class="c1"># ...</span>
    <span class="ss">email: </span><span class="no">String</span><span class="p">?,</span>
    <span class="ss">address: </span><span class="no">String</span><span class="p">?</span>
  <span class="p">)</span>

  <span class="kp">property</span> <span class="n">email_confirmation</span> <span class="p">:</span> <span class="no">String</span><span class="p">?,</span> <span class="n">address_confirmation</span> <span class="p">:</span> <span class="no">String</span><span class="p">?</span>

  <span class="n">validates_confirmation</span> <span class="p">:</span><span class="n">email</span>
  <span class="n">validates_confirmation</span> <span class="p">:</span><span class="n">address</span><span class="p">,</span> <span class="ss">case_insensitive: </span><span class="kp">true</span>
<span class="k">end</span>
</code></pre></div></div>

<p>If confirmation is nil - this validation will be skipped. Such behavior allows to normally proceed in places where this validation is not needed (e.g. email confirmation is important only during new user creating).</p>

<p>To make comparison case insensitive - specify second argument as <code class="language-plaintext highlighter-rouge">true</code>.</p>

<h3 id="validates_exclusion"><code class="language-plaintext highlighter-rouge">validates_exclusion</code></h3>

<p>This macro validates that the attribute’s value aren’t included in a given set. This could be any object which responds to <code class="language-plaintext highlighter-rouge">#includes?</code> method.</p>

<div class="language-crystal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Country</span> <span class="o">&lt;</span> <span class="no">Jennifer</span><span class="o">::</span><span class="no">Base</span><span class="o">::</span><span class="no">Model</span>
  <span class="n">mapping</span><span class="p">(</span>
    <span class="c1"># ...</span>
    <span class="ss">code: </span><span class="no">String</span>
  <span class="p">)</span>

  <span class="n">validates_exclusion</span> <span class="ss">:code</span><span class="p">,</span> <span class="ss">in: </span><span class="sx">%w(AA DD)</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="validates_format"><code class="language-plaintext highlighter-rouge">validates_format</code></h3>

<p>This macro validates that the attribute’s value satisfies given regular expression.</p>

<div class="language-crystal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Contact</span> <span class="o">&lt;</span> <span class="no">Jennifer</span><span class="o">::</span><span class="no">Model</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">mapping</span><span class="p">(</span>
    <span class="c1"># ...</span>
    <span class="ss">street: </span><span class="no">String</span>
  <span class="p">)</span>

  <span class="n">validates_format</span> <span class="ss">:street</span><span class="p">,</span> <span class="sr">/st\.|street/i</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="validates_inclusion"><code class="language-plaintext highlighter-rouge">validates_inclusion</code></h3>

<p>This macro validates that the attribute’s value are included in the set. This could be any object which responds to <code class="language-plaintext highlighter-rouge">#includes?</code> method.</p>

<div class="language-crystal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">Jennifer</span><span class="o">::</span><span class="no">Base</span><span class="o">::</span><span class="no">Model</span>
  <span class="n">mapping</span><span class="p">(</span>
    <span class="c1"># ...</span>
    <span class="ss">country_code: </span><span class="no">String</span>
  <span class="p">)</span>

  <span class="n">validates_inclusion</span> <span class="ss">:code</span><span class="p">,</span> <span class="ss">in: </span><span class="no">Country</span><span class="o">::</span><span class="no">KNOWN_COUNTRIES</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="validates_length"><code class="language-plaintext highlighter-rouge">validates_length</code></h3>

<p>This macro validates the attribute’s value length. There are a lot of options so constraint can be specified in different ways.</p>

<div class="language-crystal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">Jennifer</span><span class="o">::</span><span class="no">Model</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">mapping</span><span class="p">(</span>
    <span class="c1"># ...</span>
  <span class="p">)</span>

  <span class="n">validates_length</span> <span class="ss">:name</span><span class="p">,</span> <span class="ss">minimum: </span><span class="mi">2</span>
  <span class="n">validates_length</span> <span class="ss">:login</span><span class="p">,</span> <span class="ss">in: </span><span class="mi">4</span><span class="o">..</span><span class="mi">16</span>
  <span class="n">validates_length</span> <span class="ss">:uid</span><span class="p">,</span> <span class="ss">is: </span><span class="mi">16</span>
<span class="k">end</span>
</code></pre></div></div>

<p>The possible constraints are:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">minimum</code> - length can’t be less than specified one,</li>
  <li><code class="language-plaintext highlighter-rouge">maximum</code> - length can’t be greater than specified on,</li>
  <li><code class="language-plaintext highlighter-rouge">in</code> - length must be included in given <strong>interval</strong></li>
  <li><code class="language-plaintext highlighter-rouge">is</code> - length must be same as specified</li>
</ul>

<h3 id="validates_numericality"><code class="language-plaintext highlighter-rouge">validates_numericality</code></h3>

<p>This macro validates if given number field satisfies specified constraints.</p>

<div class="language-crystal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Player</span> <span class="o">&lt;</span> <span class="no">Jennifer</span><span class="o">::</span><span class="no">Model</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">mapping</span><span class="p">(</span>
    <span class="c1"># ...</span>
    <span class="ss">points: </span><span class="no">Float64</span><span class="p">?</span>
  <span class="p">)</span>

  <span class="n">validates_numericality</span> <span class="p">:</span><span class="n">points</span><span class="p">,</span> <span class="ss">greater_than: </span><span class="mi">0</span>
<span class="k">end</span>
</code></pre></div></div>

<p>This macro accepts following constraints:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">greater_than</code></li>
  <li><code class="language-plaintext highlighter-rouge">greater_than_or_equal_to</code></li>
  <li><code class="language-plaintext highlighter-rouge">equal_to</code></li>
  <li><code class="language-plaintext highlighter-rouge">less_than</code></li>
  <li><code class="language-plaintext highlighter-rouge">less_than_or_equal_to</code></li>
  <li><code class="language-plaintext highlighter-rouge">other_than</code></li>
  <li><code class="language-plaintext highlighter-rouge">odd</code></li>
  <li><code class="language-plaintext highlighter-rouge">even</code></li>
</ul>

<h3 id="validates_presence"><code class="language-plaintext highlighter-rouge">validates_presence</code></h3>

<p>This macro validates that attribute’s value is not empty. It uses <code class="language-plaintext highlighter-rouge">#blank?</code> method from the core pact of <a href="https://github.com/imdrasil/ifrit#core">Ifrit</a>.</p>

<div class="language-crystal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">Jennifer</span><span class="o">::</span><span class="no">Model</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">mapping</span><span class="p">(</span>
    <span class="c1"># ...</span>
    <span class="ss">email: </span><span class="no">String</span><span class="p">?</span>
  <span class="p">)</span>

  <span class="n">validates_presence</span> <span class="p">:</span><span class="n">email</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="validates_absence"><code class="language-plaintext highlighter-rouge">validates_absence</code></h3>

<p>This validates that attribute’s value is blank. It uses <code class="language-plaintext highlighter-rouge">#blank?</code> method from Ifrit as well as <code class="language-plaintext highlighter-rouge">presence</code> validation.</p>

<div class="language-crystal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">SuperUser</span> <span class="o">&lt;</span> <span class="no">User</span>
  <span class="n">mapping</span><span class="p">(</span>
    <span class="c1"># ...</span>
  <span class="p">)</span>

  <span class="n">validates_absence</span> <span class="ss">:title</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="validates_uniqueness"><code class="language-plaintext highlighter-rouge">validates_uniqueness</code></h3>

<p>This validates that the attribute’s value is unique right before object gets validated. It doesn’t create any db constraint so it doesn’t totally guaranty that another another application instance creates record with save value in overlapping time. <strong>Don’t use</strong> this validation for sensitive data. On the other hand this could help in generating readable error messages.</p>

<div class="language-crystal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Country</span> <span class="o">&lt;</span> <span class="no">Jennifer</span><span class="o">::</span><span class="no">Model</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">mapping</span><span class="p">(</span>
    <span class="c1"># ...</span>
    <span class="ss">code: </span><span class="no">String</span>
  <span class="p">)</span>

  <span class="n">validates_uniqueness</span> <span class="ss">:code</span>
<span class="k">end</span>
</code></pre></div></div>

<blockquote>
  <p>NOTE: Be aware that mysql performs case insensitive string comparison.</p>
</blockquote>

<h3 id="validates_with"><code class="language-plaintext highlighter-rouge">validates_with</code></h3>

<p>This passes the record to a new instance of given validator class to be validated.</p>

<div class="language-crystal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">EnnValidator</span> <span class="o">&lt;</span> <span class="no">Jennifer</span><span class="o">::</span><span class="no">Validations</span><span class="o">::</span><span class="no">Validator</span>
  <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="kp">record</span><span class="p">,</span> <span class="o">**</span><span class="n">opts</span><span class="p">)</span>
    <span class="k">if</span> <span class="kp">record</span><span class="p">.</span><span class="nf">enn!</span><span class="p">.</span><span class="nf">size</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="kp">record</span><span class="p">.</span><span class="nf">enn!</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">downcase</span> <span class="o">==</span> <span class="s1">'a'</span>
      <span class="kp">record</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="ss">:enn</span><span class="p">,</span> <span class="s2">"Invalid enn"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">Passport</span> <span class="o">&lt;</span> <span class="no">Jennifer</span><span class="o">::</span><span class="no">Model</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">mapping</span><span class="p">(</span>
    <span class="c1"># ...</span>
    <span class="ss">enn: </span><span class="p">{</span><span class="ss">type: </span><span class="no">String</span><span class="p">,</span> <span class="ss">primary: </span><span class="kp">true</span><span class="p">}</span>
  <span class="p">)</span>

  <span class="n">validates_with</span> <span class="no">EnnValidator</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="validates_with_method"><code class="language-plaintext highlighter-rouge">validates_with_method</code></h3>

<p>This invokes specified record method to perform validation</p>

<div class="language-crystal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">User</span> <span class="o">&lt;</span> <span class="no">Jennifer</span><span class="o">::</span><span class="no">Model</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">mapping</span><span class="p">(</span>
    <span class="ss">id: </span><span class="no">Primary</span><span class="p">?</span>
  <span class="p">)</span>

  <span class="n">validates_with_method</span> <span class="p">:</span><span class="n">thirteen</span>

  <span class="k">def</span> <span class="nf">thirteen</span>
    <span class="k">if</span> <span class="nb">id</span> <span class="o">==</span> <span class="mi">13</span>
      <span class="n">errors</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="ss">:id</span><span class="p">,</span> <span class="s2">"Can't be 13"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="if-validation-option"><code class="language-plaintext highlighter-rouge">if</code> validation option</h3>

<p>Sometimes it will make sense to validate an object only when a given predicate is satisfied. You can do that by using the :if option, which can take a symbol or an expression. You may use the :if option when you want to specify when the validation should happen.</p>

<p>The symbol value of :if options corresponds to the method name that will get called right before validation happens.</p>

<div class="language-crystal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Player</span> <span class="o">&lt;</span> <span class="no">Jennifer</span><span class="o">::</span><span class="no">Model</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">mapping</span><span class="p">(</span>
    <span class="c1"># ...</span>
    <span class="ss">health: </span><span class="no">Float64</span><span class="p">,</span>
    <span class="ss">live_creature: </span><span class="p">{</span><span class="ss">type: </span><span class="no">Bool</span><span class="p">,</span> <span class="ss">default: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">virtual: </span><span class="kp">true</span><span class="p">}</span>
  <span class="p">)</span>

  <span class="n">validates_numericality</span> <span class="ss">:health</span><span class="p">,</span> <span class="ss">greater_than: </span><span class="mi">0</span><span class="p">,</span> <span class="ss">if: :live_creature</span>
<span class="k">end</span>
</code></pre></div></div>

<p>An expression may be used to simulate <em>unless</em> behavior of simple condition without wrapping it into a method.</p>

<div class="language-crystal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Player</span> <span class="o">&lt;</span> <span class="no">Jennifer</span><span class="o">::</span><span class="no">Model</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">mapping</span><span class="p">(</span>
    <span class="c1"># ...</span>
    <span class="ss">health: </span><span class="no">Float64</span><span class="p">,</span>
    <span class="ss">undead: </span><span class="p">{</span><span class="ss">type: </span><span class="no">Bool</span><span class="p">,</span> <span class="ss">default: </span><span class="kp">false</span><span class="p">,</span> <span class="ss">virtual: </span><span class="kp">true</span><span class="p">}</span>
  <span class="p">)</span>

  <span class="n">validates_numericality</span> <span class="ss">:health</span><span class="p">,</span> <span class="ss">greater_than: </span><span class="mi">0</span><span class="p">,</span> <span class="ss">if: </span><span class="o">!</span><span class="n">undead</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="common-validation-options">Common validation options</h2>

<p>These are common validation options:</p>

<h3 id="allow_blank"><code class="language-plaintext highlighter-rouge">allow_blank</code></h3>

<p>This option skip validation if attribute’s value is <code class="language-plaintext highlighter-rouge">nil</code>. All validation methods accepts this except following:</p>

<ul>
  <li><code class="language-plaintext highlighter-rouge">uniqueness</code></li>
  <li><code class="language-plaintext highlighter-rouge">presence</code></li>
  <li><code class="language-plaintext highlighter-rouge">absence</code></li>
  <li><code class="language-plaintext highlighter-rouge">acceptance</code></li>
  <li><code class="language-plaintext highlighter-rouge">confirmation</code></li>
</ul>

<p>By default it is set to <code class="language-plaintext highlighter-rouge">false</code>.</p>

<h3 id="if"><code class="language-plaintext highlighter-rouge">if</code></h3>

<p>Sometimes it will make sense to validate an object only when a given predicate is satisfied. You can do that by using the :if option, which can take a symbol or an expression. You may use the :if option when you want to specify when the validation should happen.</p>

<p>The symbol value of :if options corresponds to the method name that will get called right before validation happens.</p>

<div class="language-crystal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Player</span> <span class="o">&lt;</span> <span class="no">Jennifer</span><span class="o">::</span><span class="no">Model</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">mapping</span><span class="p">(</span>
    <span class="c1"># ...</span>
    <span class="ss">health: </span><span class="no">Float64</span><span class="p">,</span>
    <span class="ss">live_creature: </span><span class="p">{</span><span class="ss">type: </span><span class="no">Bool</span><span class="p">,</span> <span class="ss">default: </span><span class="kp">true</span><span class="p">,</span> <span class="ss">virtual: </span><span class="kp">true</span><span class="p">}</span>
  <span class="p">)</span>

  <span class="n">validates_numericality</span> <span class="ss">:health</span><span class="p">,</span> <span class="ss">greater_than: </span><span class="mi">0</span><span class="p">,</span> <span class="ss">if: :live_creature</span>
<span class="k">end</span>
</code></pre></div></div>

<p>An expression may be used to simulate <em>unless</em> behavior of simple condition without wrapping it into a method.</p>

<div class="language-crystal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Player</span> <span class="o">&lt;</span> <span class="no">Jennifer</span><span class="o">::</span><span class="no">Model</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">mapping</span><span class="p">(</span>
    <span class="c1"># ...</span>
    <span class="ss">health: </span><span class="no">Float64</span><span class="p">,</span>
    <span class="ss">undead: </span><span class="p">{</span><span class="ss">type: </span><span class="no">Bool</span><span class="p">,</span> <span class="ss">default: </span><span class="kp">false</span><span class="p">,</span> <span class="ss">virtual: </span><span class="kp">true</span><span class="p">}</span>
  <span class="p">)</span>

  <span class="n">validates_numericality</span> <span class="ss">:health</span><span class="p">,</span> <span class="ss">greater_than: </span><span class="mi">0</span><span class="p">,</span> <span class="ss">if: </span><span class="o">!</span><span class="n">undead</span>
<span class="k">end</span>
</code></pre></div></div>

<h3 id="message"><code class="language-plaintext highlighter-rouge">message</code></h3>

<p>the <code class="language-plaintext highlighter-rouge">message</code> option lets you specify the message that will be added to the errors collection when validation fails. When this option is not used,respective default error message for each validation is used. The <code class="language-plaintext highlighter-rouge">message</code> option accepts a <code class="language-plaintext highlighter-rouge">String</code>, <code class="language-plaintext highlighter-rouge">Symbol</code> or <code class="language-plaintext highlighter-rouge">Proc</code>.</p>

<p>A <code class="language-plaintext highlighter-rouge">String</code> <code class="language-plaintext highlighter-rouge">message</code> value is used as a validation error message as-is.</p>

<p>A <code class="language-plaintext highlighter-rouge">Proc</code> <code class="language-plaintext highlighter-rouge">message</code> value is given two arguments: the object being validated and a field name.</p>

<p>A <code class="language-plaintext highlighter-rouge">Symbol</code> <code class="language-plaintext highlighter-rouge">message</code> is used as a message name and Jennifer will try to find it for model-attribute combination using default message resolving hierarchy. For more information about this read <a href="./internationalization">Internationalization</a> section.</p>

<div class="language-crystal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Person</span> <span class="o">&lt;</span> <span class="no">Jennifer</span><span class="o">::</span><span class="no">Model</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">mapping</span><span class="p">(</span>
    <span class="ss">id: </span><span class="no">Primary64</span><span class="p">,</span>
    <span class="ss">name: </span><span class="no">String</span><span class="p">?,</span>
    <span class="ss">age: </span><span class="no">Int32</span><span class="p">?,</span>
    <span class="ss">username: </span><span class="no">String</span><span class="p">?</span>
  <span class="p">)</span>

  <span class="c1"># Hard-coded message</span>
  <span class="n">validates_presence</span> <span class="p">:</span><span class="nb">name</span><span class="p">,</span> <span class="ss">message: </span><span class="s2">"must be given please"</span>

  <span class="c1"># Message i18n name.</span>
  <span class="n">validates_numericality</span> <span class="p">:</span><span class="n">age</span><span class="p">,</span> <span class="ss">greater_than: </span><span class="mi">18</span><span class="p">,</span> <span class="ss">message: </span><span class="p">:</span><span class="n">invalid</span>

  <span class="c1"># Proc</span>
  <span class="n">validates_uniqueness</span> <span class="ss">:username</span><span class="p">,</span>
    <span class="ss">message: </span><span class="o">-&gt;</span><span class="p">(</span><span class="n">object</span> <span class="p">:</span> <span class="no">Jennifer</span><span class="o">::</span><span class="no">Model</span><span class="o">::</span><span class="no">Translation</span><span class="p">,</span> <span class="n">field</span> <span class="p">:</span> <span class="no">String</span><span class="p">)</span> <span class="k">do</span>
      <span class="kp">record</span> <span class="o">=</span> <span class="n">object</span><span class="p">.</span><span class="nf">as</span><span class="p">(</span><span class="no">Person</span><span class="p">)</span>
      <span class="s2">"Hey </span><span class="si">#{</span><span class="kp">record</span><span class="p">.</span><span class="nf">name</span><span class="si">}</span><span class="s2">, </span><span class="si">#{</span><span class="kp">record</span><span class="p">.</span><span class="nf">attribute</span><span class="p">(</span><span class="n">field</span><span class="p">)</span><span class="si">}</span><span class="s2"> is already taken."</span>
    <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="custom-validation">Custom validation</h2>

<h3 id="custom-validators">Custom validators</h3>

<p>Custom validators are classes that inherit from <code class="language-plaintext highlighter-rouge">Jennifer::Validations::Validator</code> and implement <code class="language-plaintext highlighter-rouge">#validate</code> method.</p>

<div class="language-crystal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Passport</span> <span class="o">&lt;</span> <span class="no">Jennifer</span><span class="o">::</span><span class="no">Model</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">mapping</span><span class="p">(</span>
    <span class="ss">enn: </span><span class="p">{</span><span class="ss">type: </span><span class="no">String</span><span class="p">,</span> <span class="ss">primary: </span><span class="kp">true</span><span class="p">}</span>
  <span class="p">)</span>

  <span class="n">validates_with</span> <span class="no">EnnValidator</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">EnnValidator</span> <span class="o">&lt;</span> <span class="no">Jennifer</span><span class="o">::</span><span class="no">Validations</span><span class="o">::</span><span class="no">Validator</span>
  <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="kp">record</span><span class="p">)</span>
    <span class="k">if</span> <span class="kp">record</span><span class="p">.</span><span class="nf">enn!</span><span class="p">.</span><span class="nf">size</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="o">&amp;&amp;</span> <span class="kp">record</span><span class="p">.</span><span class="nf">enn!</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">downcase</span> <span class="o">==</span> <span class="s1">'a'</span>
      <span class="kp">record</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="ss">:enn</span><span class="p">,</span> <span class="s2">"Invalid enn"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>If there is any named argument specified after validator class - it will be passed to <code class="language-plaintext highlighter-rouge">#validate</code> method as well.</p>

<div class="language-crystal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Passport</span> <span class="o">&lt;</span> <span class="no">Jennifer</span><span class="o">::</span><span class="no">Model</span><span class="o">::</span><span class="no">Base</span>
  <span class="n">mapping</span><span class="p">(</span>
    <span class="ss">enn: </span><span class="p">{</span><span class="ss">type: </span><span class="no">String</span><span class="p">,</span> <span class="ss">primary: </span><span class="kp">true</span><span class="p">}</span>
  <span class="p">)</span>

  <span class="n">validates_with</span> <span class="no">EnnValidator</span><span class="p">,</span> <span class="ss">length: </span><span class="mi">6</span>
<span class="k">end</span>

<span class="k">class</span> <span class="nc">EnnValidator</span> <span class="o">&lt;</span> <span class="no">Jennifer</span><span class="o">::</span><span class="no">Validator</span>
  <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="kp">record</span><span class="p">,</span> <span class="n">length</span><span class="p">)</span>
    <span class="k">if</span> <span class="kp">record</span><span class="p">.</span><span class="nf">enn!</span><span class="p">.</span><span class="nf">size</span> <span class="o">&lt;</span> <span class="n">length</span> <span class="o">&amp;&amp;</span> <span class="kp">record</span><span class="p">.</span><span class="nf">enn!</span><span class="p">[</span><span class="mi">0</span><span class="p">].</span><span class="nf">downcase</span> <span class="o">==</span> <span class="s1">'a'</span>
      <span class="kp">record</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="ss">:enn</span><span class="p">,</span> <span class="s2">"Invalid enn"</span><span class="p">)</span>
    <span class="k">end</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<p>To override default singleton behavior of validator define <code class="language-plaintext highlighter-rouge">.instance</code> method this way:</p>

<div class="language-crystal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">CustomValidator</span> <span class="o">&lt;</span> <span class="no">Jennifer</span><span class="o">::</span><span class="no">Validations</span><span class="o">::</span><span class="no">Validator</span>
  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">instance</span>
    <span class="kp">new</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">validate</span><span class="p">(</span><span class="kp">record</span><span class="p">)</span>
  <span class="k">end</span>
<span class="k">end</span>
</code></pre></div></div>

<h2 id="accessing-errors-list">Accessing errors list</h2>

<p>Each record has a container to hold error messages - <code class="language-plaintext highlighter-rouge">Accord::ErrorList</code>. To retrieve it use <code class="language-plaintext highlighter-rouge">#errors</code> method.</p>

<p>By it own <code class="language-plaintext highlighter-rouge">#errors</code> doesn’t trigger validation so first of all you need to perform it explicitly by listed upper methods or using <code class="language-plaintext highlighter-rouge">#validate!</code> method:</p>

<div class="language-crystal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="ss">login: </span><span class="s2">"login"</span><span class="p">)</span>
<span class="n">user</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">any?</span> <span class="c1"># false</span>
<span class="n">user</span><span class="p">.</span><span class="nf">validate!</span>
<span class="n">user</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">any?</span> <span class="c1"># true</span>
</code></pre></div></div>

<h3 id="errors"><code class="language-plaintext highlighter-rouge">errors[]</code></h3>

<p>To check whether or not a particular attribute of an object is valid you can use  <code class="language-plaintext highlighter-rouge">#errors[:attribute]</code>. It returns an array of error messages for <code class="language-plaintext highlighter-rouge">:attribute</code>. If there is no error - empty array will be returned.</p>

<h3 id="errorsadd"><code class="language-plaintext highlighter-rouge">#errors.add</code></h3>

<p>This methods let you add an error message related to a particular attribute. It takes as arguments tre attribute and the error message.</p>

<div class="language-crystal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">user</span> <span class="o">=</span> <span class="no">User</span><span class="p">.</span><span class="nf">create</span><span class="p">(</span><span class="ss">login: </span><span class="s2">"login"</span><span class="p">)</span>
<span class="n">user</span><span class="p">.</span><span class="nf">errors</span><span class="p">.</span><span class="nf">add</span><span class="p">(</span><span class="ss">:login</span><span class="p">,</span> <span class="s2">"Some custom message"</span><span class="p">)</span>
</code></pre></div></div>

<h3 id="errorsclear"><code class="language-plaintext highlighter-rouge">errors.clear!</code></h3>

<p>The <code class="language-plaintext highlighter-rouge">#clear!</code> method is used when all error messages should be removed. It is automatically invoked by <code class="language-plaintext highlighter-rouge">#validate!</code>.</p>

<h3 id="non-model-usage">Non-model usage</h3>

<p>It is possible to use <code class="language-plaintext highlighter-rouge">Jennifer::Model::Errors</code> for handling errors of any class that includes <code class="language-plaintext highlighter-rouge">Jennifer::Model::Translation</code> and implements <code class="language-plaintext highlighter-rouge">.superclass</code> method.</p>

<div class="language-crystal highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Post</span>
  <span class="kp">include</span> <span class="no">Jennifer</span><span class="o">::</span><span class="no">Model</span><span class="o">::</span><span class="no">Translation</span>

  <span class="kp">property</span> <span class="n">title</span> <span class="p">:</span> <span class="no">String</span><span class="p">?</span>
  <span class="kp">getter</span> <span class="n">errors</span>

  <span class="k">def</span> <span class="nf">initialize</span>
    <span class="vi">@errors</span> <span class="o">=</span> <span class="no">Jennifer</span><span class="o">::</span><span class="no">Model</span><span class="o">::</span><span class="no">Errors</span><span class="p">.</span><span class="nf">new</span><span class="p">(</span><span class="nb">self</span><span class="p">)</span>
  <span class="k">end</span>

  <span class="k">def</span> <span class="nf">validate</span>
    <span class="n">errors</span><span class="p">.</span><span class="nf">clear</span>
    <span class="n">errors</span><span class="p">.</span><span class="nf">add</span><span class="p">(:</span><span class="n">title</span><span class="p">,</span> <span class="ss">:blank</span><span class="p">)</span> <span class="k">if</span> <span class="n">title</span><span class="p">.</span><span class="nf">nil?</span>
  <span class="k">end</span>

  <span class="c1"># The following method is needed to be minimally implemented</span>

  <span class="k">def</span> <span class="nc">self</span><span class="o">.</span><span class="nf">superclass</span><span class="p">;</span> <span class="k">end</span>
<span class="k">end</span>

<span class="n">post</span> <span class="o">=</span> <span class="no">Post</span><span class="p">.</span><span class="nf">new</span>
<span class="n">post</span><span class="p">.</span><span class="nf">validate</span>
<span class="n">post</span><span class="p">.</span><span class="nf">errors</span><span class="p">[</span><span class="ss">:title</span><span class="p">]</span> <span class="c1"># "can't be blank"</span>
</code></pre></div></div>

  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Imdrasil Homebrew Stuff</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Imdrasil Homebrew Stuff</li><li><a class="u-email" href="mailto:moranibaca@gmail.com">moranibaca@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/imdrasil"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">imdrasil</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Personal site</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
