<!DOCTYPE html>
<html lang="en"><head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1"><!-- Begin Jekyll SEO tag v2.5.0 -->
<title>Imdrasil Homebrew Stuff | Personal site</title>
<meta name="generator" content="Jekyll v3.7.4" />
<meta property="og:title" content="Imdrasil Homebrew Stuff" />
<meta property="og:locale" content="en_US" />
<meta name="description" content="Personal site" />
<meta property="og:description" content="Personal site" />
<link rel="canonical" href="https://imdrasil.github.io/jennifer.cr/docs/migration.html" />
<meta property="og:url" content="https://imdrasil.github.io/jennifer.cr/docs/migration.html" />
<meta property="og:site_name" content="Imdrasil Homebrew Stuff" />
<script type="application/ld+json">
{"description":"Personal site","@type":"WebPage","url":"https://imdrasil.github.io/jennifer.cr/docs/migration.html","headline":"Imdrasil Homebrew Stuff","@context":"http://schema.org"}</script>
<!-- End Jekyll SEO tag -->
<link rel="stylesheet" href="/assets/main.css"><link type="application/atom+xml" rel="alternate" href="https://imdrasil.github.io/feed.xml" title="Imdrasil Homebrew Stuff" /></head>
<body><header class="site-header" role="banner">

  <div class="wrapper"><a class="site-title" rel="author" href="/">Imdrasil Homebrew Stuff</a><nav class="site-nav">
        <input type="checkbox" id="nav-trigger" class="nav-trigger" />
        <label for="nav-trigger">
          <span class="menu-icon">
            <svg viewBox="0 0 18 15" width="18px" height="15px">
              <path d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.032C17.335,0,18,0.665,18,1.484L18,1.484z M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.032C17.335,6.031,18,6.696,18,7.516L18,7.516z M18,13.516C18,14.335,17.335,15,16.516,15H1.484 C0.665,15,0,14.335,0,13.516l0,0c0-0.82,0.665-1.483,1.484-1.483h15.032C17.335,12.031,18,12.695,18,13.516L18,13.516z"/>
            </svg>
          </span>
        </label>

        <div class="trigger"><a class="page-link" href="/email_opener/">Email Opener</a><a class="page-link" href="/sage/">Sage</a><a class="page-link" href="/flash_container.cr/">flash_container</a><a class="page-link" href="/jennifer.cr/">Jennifer</a><a class="page-link" href="/jennifer_sqlite3_adapter/">Jennifer SQLite3 adapter</a><a class="page-link" href="/http_method_emulator/">http_method_emulator</a><a class="page-link" href="/sam.cr/">Sam</a><a class="page-link" href="/view_model.cr/">ViewModel</a><a class="page-link" href="/form_object/">FormObject</a><a class="page-link" href="/hermes.cr/">Hermes</a><a class="page-link" href="/crymagick/">CryMagick</a><a class="page-link" href="/factory/">Factory</a><a class="page-link" href="/pager/">Pager</a><a class="page-link" href="/ifrit/">Ifrit</a><a class="page-link" href="/email_opener/versions.html">email_opener</a><a class="page-link" href="/sage/versions.html">sage</a><a class="page-link" href="/flash_container.cr/versions.html">flash_container.cr</a><a class="page-link" href="/jennifer.cr/versions.html">jennifer.cr</a><a class="page-link" href="/jennifer_sqlite3_adapter/versions.html">jennifer_sqlite3_adapter</a><a class="page-link" href="/http_method_emulator/versions.html">http_method_emulator</a><a class="page-link" href="/sam.cr/versions.html">sam.cr</a><a class="page-link" href="/view_model.cr/versions.html">view_model.cr</a><a class="page-link" href="/form_object/versions.html">form_object</a><a class="page-link" href="/hermes.cr/versions.html">hermes.cr</a><a class="page-link" href="/crymagick/versions.html">crymagick</a><a class="page-link" href="/factory/versions.html">factory</a><a class="page-link" href="/pager/versions.html">pager</a><a class="page-link" href="/ifrit/versions.html">ifrit</a></div>
      </nav></div>
</header>
<main class="page-content" aria-label="Content">
      <div class="wrapper">
        <article class="post">

  <header class="post-header">
    <h1 class="post-title"></h1>
  </header>

  <div class="post-content">
    <header class="site-header" role="banner">
  <div class="wrapper">
    <nav class="site-nav">
      <div class="trigger">
        
          <a class="page-link" href="./callbacks">Callbacks</a>
        
          <a class="page-link" href="./model_sti">STI</a>
        
          <a class="page-link" href="./timestamps">Timestamps</a>
        
          <a class="page-link" href="./eager_loading">Eager Loading</a>
        
          <a class="page-link" href="./validation">Validation</a>
        
          <a class="page-link" href="./query_dsl">Query DSL</a>
        
          <a class="page-link" href="./configuration">Configuration</a>
        
          <a class="page-link" href="./index">Jennifer Documentation</a>
        
          <a class="page-link" href="./model_mapping">Mapping</a>
        
          <a class="page-link" href="./view">Views</a>
        
          <a class="page-link" href="./transaction_and_lock">Transaction &amp; Lock</a>
        
          <a class="page-link" href="./time">Time</a>
        
          <a class="page-link" href="./internationalization">Internationalization</a>
        
          <a class="page-link" href="./record">Record</a>
        
          <a class="page-link" href="./migration">Migration</a>
        
          <a class="page-link" href="./pagination_and_ordering">Pagination &amp; Ordering</a>
        
          <a class="page-link" href="./relations">Relations</a>
        
          <a class="page-link" href="./crud">CRUD</a>
        
          <a class="page-link" href="./aggregation">Aggregations</a>
        
          <a class="page-link" href="./authentication">Authentication</a>
        
          <a class="page-link" href="./command_line">Command Line</a>
        
          <a class="page-link" href="./model_scopes">Scopes</a>
        
      </div>
    </nav>
  </div>
</header>

<h1 id="migration">Migration</h1>

<h2 id="dsl">DSL</h2>

<p>Generator will create template file for you with next name  pattern “timestamp_your_underscored_migration_name.cr”. Empty file looks like this:</p>

<pre><code class="language-crystal">class YourCamelcasedMigrationName20170119011451314 &lt; Jennifer::Migration::Base
  def up
  end

  def down
  end
end
</code></pre>

<p><code class="highlighter-rouge">up</code> method is needed for placing your db changes there, <code class="highlighter-rouge">down</code> - for reverting your changes back.</p>

<p>Regular example for creating table:</p>

<pre><code class="language-crystal">create_table(:addresses) do |t|
  # creates field contact_id with Int type, allows null values and creates foreign key
  t.reference :contact

  t.string :street, {:size =&gt; 20, :sql_type =&gt; "char"} # creates string field with CHAR(20) db type
  t.bool :main, {:default =&gt; false} # sets false as default value
end
</code></pre>

<p>There are next methods which presents corresponding types:</p>

<table>
  <thead>
    <tr>
      <th>Method</th>
      <th>PostgreSQL</th>
      <th>MySql</th>
      <th>Crystal type</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">#integer</code></td>
      <td><code class="highlighter-rouge">int</code></td>
      <td><code class="highlighter-rouge">int</code></td>
      <td><code class="highlighter-rouge">Int32</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">#short</code></td>
      <td><code class="highlighter-rouge">SMALLINT</code></td>
      <td><code class="highlighter-rouge">SMALLINT</code></td>
      <td><code class="highlighter-rouge">Int16</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">#bigint</code></td>
      <td><code class="highlighter-rouge">BIGINT</code></td>
      <td><code class="highlighter-rouge">BIGINT</code></td>
      <td><code class="highlighter-rouge">Int64</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">#tinyint</code></td>
      <td>-</td>
      <td><code class="highlighter-rouge">TINYINT</code></td>
      <td><code class="highlighter-rouge">Int8</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">#float</code></td>
      <td><code class="highlighter-rouge">real</code></td>
      <td><code class="highlighter-rouge">float</code></td>
      <td><code class="highlighter-rouge">Float32</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">#double</code></td>
      <td><code class="highlighter-rouge">double precision</code></td>
      <td><code class="highlighter-rouge">double</code></td>
      <td><code class="highlighter-rouge">Float64</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">#numeric</code></td>
      <td><code class="highlighter-rouge">NUMERIC</code></td>
      <td>-</td>
      <td><code class="highlighter-rouge">PG::Numeric</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">#decimal</code></td>
      <td><code class="highlighter-rouge">DECIMAL</code></td>
      <td><code class="highlighter-rouge">DECIMAL</code></td>
      <td><code class="highlighter-rouge">PG::Numeric</code> (pg); <code class="highlighter-rouge">Float64</code> (mysql)</td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">#string</code></td>
      <td><code class="highlighter-rouge">varchar(254)</code></td>
      <td><code class="highlighter-rouge">varchar(254)</code></td>
      <td><code class="highlighter-rouge">String</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">#char</code></td>
      <td><code class="highlighter-rouge">char</code></td>
      <td>-</td>
      <td><code class="highlighter-rouge">String</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">#var_string</code> / <code class="highlighter-rouge">#varchar</code></td>
      <td><code class="highlighter-rouge">varchar(254)</code></td>
      <td><code class="highlighter-rouge">varstring</code></td>
      <td><code class="highlighter-rouge">String</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">#text</code></td>
      <td><code class="highlighter-rouge">TEXT</code></td>
      <td><code class="highlighter-rouge">TEXT</code></td>
      <td><code class="highlighter-rouge">String</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">#bool</code></td>
      <td><code class="highlighter-rouge">boolean</code></td>
      <td><code class="highlighter-rouge">bool</code></td>
      <td><code class="highlighter-rouge">Bool</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">#timestamp</code></td>
      <td><code class="highlighter-rouge">timestamp</code></td>
      <td><code class="highlighter-rouge">datetime</code></td>
      <td><code class="highlighter-rouge">Time</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">#date_time</code></td>
      <td><code class="highlighter-rouge">datetime</code></td>
      <td><code class="highlighter-rouge">datetime</code></td>
      <td><code class="highlighter-rouge">Time</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">#blob</code></td>
      <td><code class="highlighter-rouge">blob</code></td>
      <td><code class="highlighter-rouge">blob</code></td>
      <td><code class="highlighter-rouge">Bytes</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">#json</code></td>
      <td><code class="highlighter-rouge">json</code></td>
      <td><code class="highlighter-rouge">json</code></td>
      <td><code class="highlighter-rouge">JSON::Any</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">#enum</code></td>
      <td>-</td>
      <td><code class="highlighter-rouge">ENUM</code></td>
      <td><code class="highlighter-rouge">String</code></td>
    </tr>
  </tbody>
</table>

<p>In Postgres enum type is defined using custom user datatype which also is mapped to the <code class="highlighter-rouge">String</code>.</p>

<p>PostgreSQL specific datatypes:</p>

<table>
  <thead>
    <tr>
      <th>Method</th>
      <th>Datatype</th>
      <th>Type</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td><code class="highlighter-rouge">#oid</code></td>
      <td><code class="highlighter-rouge">OID</code></td>
      <td><code class="highlighter-rouge">UInt32</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">#jsonb</code></td>
      <td><code class="highlighter-rouge">JSONB</code></td>
      <td><code class="highlighter-rouge">JSON::Any</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">#xml</code></td>
      <td><code class="highlighter-rouge">XML</code></td>
      <td><code class="highlighter-rouge">String</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">#blchar</code></td>
      <td><code class="highlighter-rouge">BLCHAR</code></td>
      <td><code class="highlighter-rouge">String</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">#uuid</code></td>
      <td><code class="highlighter-rouge">UUID</code></td>
      <td><code class="highlighter-rouge">String</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">#timestampz</code></td>
      <td><code class="highlighter-rouge">TIMESTAMPZ</code></td>
      <td><code class="highlighter-rouge">Time</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">#point</code></td>
      <td><code class="highlighter-rouge">POINT</code></td>
      <td><code class="highlighter-rouge">PG::Geo::Point</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">#lseg</code></td>
      <td><code class="highlighter-rouge">lseg</code></td>
      <td><code class="highlighter-rouge">PG::Geo::LineSegment</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">#path</code></td>
      <td><code class="highlighter-rouge">PATH</code></td>
      <td><code class="highlighter-rouge">PG::Geo::Path</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">#box</code></td>
      <td><code class="highlighter-rouge">BOX</code></td>
      <td><code class="highlighter-rouge">PG::Geo::Box</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">#polygon</code></td>
      <td><code class="highlighter-rouge">POLYGON</code></td>
      <td><code class="highlighter-rouge">PG::Geo::Polygon</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">#line</code></td>
      <td><code class="highlighter-rouge">LINE</code></td>
      <td><code class="highlighter-rouge">PG::Geo::Line</code></td>
    </tr>
    <tr>
      <td><code class="highlighter-rouge">#circle</code></td>
      <td><code class="highlighter-rouge">CIRCLE</code></td>
      <td><code class="highlighter-rouge">PG::Geo::Circle</code></td>
    </tr>
  </tbody>
</table>

<p>Also if you use postgres array types are available as well: <code class="highlighter-rouge">Array(Int32)</code>, <code class="highlighter-rouge">Array(Char)</code>, <code class="highlighter-rouge">Array(Float32)</code>,  <code class="highlighter-rouge">Array(Float64)</code>, <code class="highlighter-rouge">Array(Int16)</code>, <code class="highlighter-rouge">Array(Int32)</code>, <code class="highlighter-rouge">Array(Int64)</code>, <code class="highlighter-rouge">Array(String)</code>.</p>

<p>All those methods accepts additional options:</p>

<ul>
  <li><code class="highlighter-rouge">:sql_type</code> - gets exact (except size) field type;</li>
  <li><code class="highlighter-rouge">:null</code> - present nullable if field (by default is <code class="highlighter-rouge">false</code> for all types and field);</li>
  <li><code class="highlighter-rouge">:primary</code> - marks field as primary key field (could be several ones but this provides some bugs with query generation for such model - for now try to avoid this).</li>
  <li><code class="highlighter-rouge">:default</code> - default value for field</li>
  <li><code class="highlighter-rouge">:auto_increment</code> - marks field to use auto increment (properly works only with <code class="highlighter-rouge">Int32</code> fields, another crystal types have cut functionality for it);</li>
  <li><code class="highlighter-rouge">:array</code> - mark field to be array type (postgres only)</li>
</ul>

<p>Also there is <code class="highlighter-rouge">#field</code> method which allows to directly define sql type.</p>

<p>To drop table just write:</p>

<pre><code class="language-crystal">drop_table(:addresses)
</code></pre>

<p>To create materialized view (postgres only):</p>

<pre><code class="language-crystal">create_materialized_view("female_contacts", Contact.all.where { _gender == "female" })
</code></pre>

<p>And to drop it:</p>

<pre><code class="language-crystal">drop_materialized_view("female_contacts")
</code></pre>

<p>To alter existing table use next methods:</p>

<ul>
  <li><code class="highlighter-rouge">#change_column(name, [new_name], options)</code> - to change column definition; postgres has slighly another implementation of this than mysql one - check source code for details;</li>
  <li><code class="highlighter-rouge">#add_column(name, type, options)</code> - add new column;</li>
  <li><code class="highlighter-rouge">#drop_column(name)</code> - drops existing column</li>
  <li><code class="highlighter-rouge">#add_index(name : String, field : Symbol, type : Symbol, order : Symbol?, length : Int32?)</code> - adds new index (postgres doesn’t support length parameter and only support <code class="highlighter-rouge">:unique</code> type);</li>
  <li><code class="highlighter-rouge">#drop_index(name : String)</code> - drops existing index;</li>
  <li><code class="highlighter-rouge">#add_foreign_key(from_table, to_table, column = nil, primary_key = nil, name = nil)</code> - adds foreign key constraint;</li>
  <li><code class="highlighter-rouge">drop_foreign_key(from_table, to_table, name = nil)</code> - drops foreign key constraint;</li>
  <li><code class="highlighter-rouge">#rename_table(new_name)</code> - renames table.</li>
</ul>

<p>Also next support methods are available:</p>

<ul>
  <li><code class="highlighter-rouge">#table_exists?(name)</code></li>
  <li><code class="highlighter-rouge">#index_exists?(table, name)</code></li>
  <li><code class="highlighter-rouge">#column_exists?(table, name)</code></li>
  <li><code class="highlighter-rouge">#foreign_key_exists?(from_table, to_table)</code></li>
  <li><code class="highlighter-rouge">#data_type_exists?(name)</code> for postgres ENUM</li>
  <li><code class="highlighter-rouge">#material_view_exists?(name)</code></li>
</ul>

<p>Here is quick example:</p>

<pre><code class="language-crystal">def up
  change_table(:contacts) do |t|
    t.change_column(:age, :short, {default: 0})
    t.add_column(:description, :text)
    t.add_index("contacts_description_index", :description, type: :uniq, order: :asc)
  end

  change_table(:addresses) do |t|
    t.add_column(:details, :json)
  end
end

def down
  change_table(:contacts) do |t|
    t.change_column(:age, :integer, {default: 0})
    t.drop_column(:description)
  end

  change_table(:addresses) do |t|
    t.drop_column(:details)
  end
end
</code></pre>

<p>Also plain SQL could be executed as well:</p>

<pre><code class="language-crystal">execute("ALTER TABLE addresses CHANGE street st VARCHAR(20)")
</code></pre>

<p>All changes are executed one by one so you also could add data changes here (in <code class="highlighter-rouge">up</code> method) but if execution of <code class="highlighter-rouge">up</code> method fails - <code class="highlighter-rouge">down</code> method will be called and all process will stop - be ready for such behavior.</p>

<p>To be sure that your db is up to date before run tests of your application, add <code class="highlighter-rouge">Jennifer::Migration::Runner.migrate</code>.</p>

<h4 id="enum">Enum</h4>

<p>Now enums are supported as well but it has different implementation for adapters. For mysql is enough just write down all values:</p>

<pre><code class="language-crystal">create_table(:contacts) do |t|
  t.enum(:gender, values: ["male", "female"])
end
</code></pre>

<p>Postgres provide much more flexible and complex behavior. Using it you need to create it firstly:</p>

<pre><code class="language-crystal">create_enum(:gender_enum, ["male", "female"])
create_table(:contacts) do |t|
  t.string :name, {:size =&gt; 30}
  t.integer :age
  t.field :gender, :gender_enum
  t.timestamps
end
change_enum(:gender_enum, {:add_values =&gt; ["unknown"]})
change_enum(:gender_enum, {:rename_values =&gt; ["unknown", "other"]})
change_enum(:gender_enum, {:remove_values =&gt; ["other"]})
</code></pre>

<p>For more details check source code and PostgreSQL docs.</p>

  </div>

</article>

      </div>
    </main><footer class="site-footer h-card">
  <data class="u-url" href="/"></data>

  <div class="wrapper">

    <h2 class="footer-heading">Imdrasil Homebrew Stuff</h2>

    <div class="footer-col-wrapper">
      <div class="footer-col footer-col-1">
        <ul class="contact-list">
          <li class="p-name">Imdrasil Homebrew Stuff</li><li><a class="u-email" href="mailto:moranibaca@gmail.com">moranibaca@gmail.com</a></li></ul>
      </div>

      <div class="footer-col footer-col-2"><ul class="social-media-list"><li><a href="https://github.com/imdrasil"><svg class="svg-icon"><use xlink:href="/assets/minima-social-icons.svg#github"></use></svg> <span class="username">imdrasil</span></a></li></ul>
</div>

      <div class="footer-col footer-col-3">
        <p>Personal site</p>
      </div>
    </div>

  </div>

</footer>
</body>

</html>
